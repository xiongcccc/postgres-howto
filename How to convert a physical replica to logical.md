# How to convert a physical replica to logical

>æˆ‘æ¯å¤©éƒ½ä¼šå‘å¸ƒä¸€ç¯‡æ–°çš„ PostgreSQL "howto" æ–‡ç« ã€‚åŠ å…¥æˆ‘çš„æ—…ç¨‹å§ â€” è®¢é˜…ã€æä¾›åé¦ˆã€åˆ†äº«ï¼

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå°†ç°æœ‰çš„å¼‚æ­¥ç‰©ç†å‰¯æœ¬è½¬æ¢ä¸ºé€»è¾‘å‰¯æœ¬å¯èƒ½æ˜¯æœ‰åˆ©çš„ï¼Œæˆ–è€…å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰©ç†å‰¯æœ¬ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºé€»è¾‘å‰¯æœ¬ã€‚

è¿™ç§æ–¹å¼ï¼š

- ä¸€æ–¹é¢ï¼Œæ¶ˆé™¤äº†åŠ è½½åˆå§‹æ•°æ®è¿™ä¸€æ­¥éª¤çš„å¿…è¦ï¼Œè¿™ä¸ªæ­¥éª¤åœ¨å¤„ç†å¤§å‹ã€è´Ÿè½½ç¹é‡çš„æ•°æ®åº“æ—¶å¯èƒ½ä¼šå¾ˆè„†å¼±ä¸”å‹åŠ›å¾ˆå¤§ã€‚
- å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºçš„é€»è¾‘å‰¯æœ¬æ‹¥æœ‰æº Postgres å®ä¾‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚

å› æ­¤ï¼Œè¿™ç§æ–¹æ³•éå¸¸é€‚ç”¨äºéœ€è¦å°†æºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®å‘ˆç°åœ¨æ–°åˆ›å»ºçš„é€»è¾‘å‰¯æœ¬ä¸­çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†éå¸¸å¤§ä¸”è´Ÿè½½ç¹é‡çš„é›†ç¾¤æ—¶æä¸ºæœ‰ç”¨ã€‚

ä¸‹é¢çš„æ­¥éª¤ååˆ†ç®€å•ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç‰©ç†å‰¯æœ¬ï¼Œé€šè¿‡æµå¤åˆ¶ `primary_conninfo` å’Œå¤åˆ¶æ§½ (æ¯”å¦‚é€šè¿‡ Patroni è¿›è¡Œæ§åˆ¶) ç«‹å³ä»ä¸»åº“å¤åˆ¶æ•°æ®ï¼Œä¸æ¶‰åŠçº§è”å¤åˆ¶ (å°½ç®¡ä¹Ÿæœ‰å¯èƒ½å®ç°)ã€‚

## æ­¥éª¤1ï¼šé€‰æ‹©ä¸€ä¸ªç”¨äºè½¬æ¢çš„ç‰©ç†å‰¯æœ¬

é€‰æ‹©ä¸€ä¸ªç‰©ç†å‰¯æœ¬è¿›è¡Œè½¬æ¢ï¼Œæˆ–è€…é€šè¿‡ `pg_basebackup`ã€ä»å¤‡ä»½æ¢å¤æˆ–ä»äº‘å¿«ç…§åˆ›å»ºæ–°çš„ç‰©ç†å‰¯æœ¬ã€‚

ç¡®ä¿åœ¨è½¬æ¢æœŸé—´æ²¡æœ‰ç”¨æˆ·ä½¿ç”¨è¯¥å‰¯æœ¬ã€‚

## æ­¥éª¤2ï¼šç¡®ä¿æ»¡è¶³è¦æ±‚

é¦–å…ˆï¼Œç¡®ä¿ä¸ºé€»è¾‘å¤åˆ¶é…ç½®äº†ç›¸å…³è®¾ç½®ï¼Œå¦‚[é€»è¾‘å¤åˆ¶é…ç½®ä¸­](https://postgresql.org/docs/current/logical-replication-config.html)æ‰€è¿°ã€‚

ä¸»åº“è®¾ç½®ï¼š

- `wal_level = 'logical'`
- `max_replication_slots > 0`
- `max_wal_senders > max_replication_slots`

åœ¨æˆ‘ä»¬å°†è¦è½¬æ¢çš„ç‰©ç†å‰¯æœ¬ä¸Šï¼š

- `max_replication_slots > 0`
- `max_logical_replication_workers > 0`
- `max_worker_processes >= max_logical_replication_workers + 1`

æ­¤å¤–ï¼š

- å¤åˆ¶å»¶è¿Ÿè¾ƒå°ï¼›
- æ¯ä¸ªè¡¨éƒ½æœ‰ä¸»é”®æˆ–è®¾ç½®äº† [REPLICA IDENTITY FULL](https://postgresql.org/docs/current/sql-altertable.html#SQL-ALTERTABLE-REPLICA-IDENTITY);
- ç”¨äºè½¬æ¢çš„å‰¯æœ¬æ²¡æœ‰è®¾ç½® `restore_command` (å¦‚æœæœ‰ï¼Œä¸´æ—¶å°†å…¶å€¼è®¾ä¸ºç©ºå­—ç¬¦ä¸²)ï¼›
- ä¸´æ—¶å¢åŠ ä¸»åº“ä¸Šçš„ `wal_keep_size`  (PG13+ï¼Œåœ¨ PG12 æˆ–æ›´æ—©ç‰ˆæœ¬ä¸­ä¸º `wal_keep_segments`)ï¼Œå¢åŠ åˆ°å¯¹åº”äºå‡ ä¸ªå°æ—¶ WAL ç”Ÿæˆçš„é‡ã€‚

## æ­¥éª¤3ï¼šåœæ­¢ç‰©ç†å‰¯æœ¬

å…³é—­ç‰©ç†å‰¯æœ¬ï¼Œå¹¶åœ¨ä¸‹ä¸€æ­¥æ‰§è¡ŒæœŸé—´ä¿æŒå…¶å…³é—­ã€‚è¿™ç¡®ä¿å…¶ä½ç½®æ¯”æˆ‘ä»¬å°†åœ¨ä¸»åº“ä¸Šåˆ›å»ºçš„é€»è¾‘æ§½çš„ä½ç½®æ—©ã€‚

## æ­¥éª¤4ï¼šåˆ›å»ºå‘å¸ƒã€é€»è¾‘æ§½å¹¶è®°å½•å…¶LSN

åœ¨ä¸»åº“ä¸Šï¼š

1. æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ `CHECKPOINT`ï¼›
2. åˆ›å»ºå‘å¸ƒï¼›
3. åˆ›å»ºé€»è¾‘å¤åˆ¶æ§½å¹¶è®°å½•å…¶ LSN ä½ç½®ã€‚

ç¤ºä¾‹ï¼š

```sql
checkpoint;

create publication my_pub for all tables;

select lsn
from pg_create_logical_replication_slot(
  'my_slot',
  'pgoutput'
);
```

è¯·åŠ¡å¿…è®°ä½æœ€åä¸€æ¡å‘½ä»¤è¿”å›çš„ LSN å€¼ â€” ç¨åæˆ‘ä»¬ä¼šä½¿ç”¨åˆ°å®ƒã€‚

## æ­¥éª¤5ï¼šè®©ç‰©ç†å‰¯æœ¬è¿½èµ¶ä¸Šä¸»åº“

é‡æ–°é…ç½®ç‰©ç†å‰¯æœ¬ï¼š

- `recovery_target_lsn` â€” å°†å…¶è®¾ç½®ä¸ºä¸Šä¸€æ­¥è·å¾—çš„ LSN å€¼
- `recovery_target_action = 'promote'`
- `restore_command`,`recovery_target_timeline`,`recovery_target_xid`,`recovery_target_time`,`recovery_target_name` ä¸ºç©ºæˆ–æœªè®¾ç½®ã€‚

ç°åœ¨å¯åŠ¨ç‰©ç†å‰¯æœ¬ï¼Œç›‘æ§å…¶å»¶è¿Ÿæƒ…å†µï¼Œç›´åˆ°å‰¯æœ¬è¿½èµ¶ä¸Šæˆ‘ä»¬éœ€è¦çš„ LSN å¹¶è‡ªåŠ¨æå‡ã€‚è¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚å®Œæˆä¹‹åè¿›è¡Œæ£€æŸ¥ï¼š

```sql
select pg_is_in_recovery();
```

- å¿…é¡»è¿”å› `f`ï¼Œè¿™æ„å‘³ç€è¯¥èŠ‚ç‚¹ç°åœ¨æœ¬èº«å°±æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ (ä¸€ä¸ªå…‹éš†èŠ‚ç‚¹)ï¼Œå…¶ä½ç½®ä¸æºèŠ‚ç‚¹ä¸Šçš„å¤åˆ¶æ§½ä½ç½®ç›¸å¯¹åº”ã€‚

## æ­¥éª¤6ï¼šåˆ›å»ºè®¢é˜…å¹¶å¯åŠ¨é€»è¾‘å¤åˆ¶

åœ¨æ–°åˆ›å»ºçš„"å…‹éš†"èŠ‚ç‚¹ä¸Šï¼Œåˆ›å»ºé€»è¾‘è®¢é˜… `copy_data = false` å’Œ `create_slot = false`ï¼š

```sql
create subscription 'my_sub'
connection 'host=.. port=.. user=.. dbname=..'
publication my_pub
with (
  copy_data = false,
  create_slot=false,
  slot_name = 'my_slot'
);
```

ç¡®ä¿å¤åˆ¶å¤„äºè¿è¡Œä¸­çš„çŠ¶æ€ â€” åœ¨æºä¸»åº“ä¸Šæ£€æŸ¥ï¼š

```sql
select * from pg_replication_slots;
```

ç¡®ä¿ `active` å­—æ®µä¸º `t`ã€‚

## å®Œæˆ

- ç­‰å¾…é€»è¾‘å¤åˆ¶çš„å»¶è¿Ÿå®Œå…¨èµ¶ä¸Š (å¶å°”å‡ºç°çš„å³°å€¼æ˜¯æ­£å¸¸çš„)ã€‚
- å°†ä¸»åº“ä¸Šçš„`wal_keep_size` (æˆ– `wal_keep_segments`) æ¢å¤åˆ°åŸå§‹å€¼ã€‚

## é¢å¤–è¯´æ˜

åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å•ä¸ªå‘å¸ƒå’Œé€»è¾‘å¤åˆ¶æ§½ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šä¸ªæ§½ï¼Œåªéœ€å¯¹è¿‡ç¨‹è¿›è¡Œä¸€äº›è°ƒæ•´ã€‚ä½†æ˜¯ï¼Œå¦‚æœé€‰æ‹©è¿™æ ·åšï¼Œè¯·è®°ä½ä½¿ç”¨å¤šä¸ªå¤åˆ¶æ§½/å‘å¸ƒçš„æ½œåœ¨å¤æ‚æ€§ï¼Œé¦–å…ˆæ˜¯è¿™äº›ï¼š

- æ— æ³•ä¿è¯é€»è¾‘å‰¯æœ¬çš„å¼•ç”¨å®Œæ•´æ€§ (å¶å°”ä¼šæš‚æ—¶æ€§åœ°è¿å FK)ï¼Œ
- å¤šä¸ªå‘å¸ƒçš„åˆ›å»ºæ›´ä¸ºè„†å¼± (åˆ›å»º `FOR ALL TABLES` çš„å‘å¸ƒä¸éœ€è¦è¡¨çº§é”ï¼Œä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨å¤šä¸ªå‘å¸ƒï¼Œå¹¶ä¸ºæŸäº›è¡¨åˆ›å»ºå‘å¸ƒæ—¶ï¼Œéœ€è¦è¡¨çº§é” â€” ç„¶è€Œï¼Œè¿™åªæ˜¯ `ShareUpdateExclusiveLock`ï¼Œå‚è€ƒ [this comment on PostgreSQL source code](https://github.com/postgres/postgres/blob/1b6da28e0668eb977dcab6987d192ddedf32b752/src/backend/commands/publicationcmds.c#L1550)).

ä»¥åŠæ— è®ºå¦‚ä½•ï¼š

- ç¡®ä¿å·²å‡†å¤‡å¥½å¤„ç†å¯¹åº”ç‰ˆæœ¬çš„é€»è¾‘å¤åˆ¶é™åˆ¶ (ä¾‹å¦‚ï¼Œ[PG16](https://postgresql.org/docs/16/logical-replication-restrictions.html))ï¼›
- å¦‚æœè€ƒè™‘ä½¿ç”¨æ­¤æ–¹æ³•æ‰§è¡Œå¤§ç‰ˆæœ¬å‡çº§ï¼Œè¯·é¿å…åœ¨å·²è½¬æ¢çš„èŠ‚ç‚¹ä¸Šè¿è¡Œ `pg_upgrade` â€” è¿™å¯èƒ½ä¸å®‰å…¨ (å‚ç…§ï¼š[pg_upgrade and logical replication](https://postgresql.org/message-id/flat/20230217075433.u5mjly4d5cr4hcfe@jrouhaud))ã€‚

# æˆ‘è§

çœ‹äº†ä¸€ä¸‹æ“ä½œæµç¨‹ï¼Œç¡®å®ååˆ†ç¹çï¼Œ17 ç‰ˆæœ¬ä¸­çš„ pg_createsubscriber æ— ç–‘æ˜¯ä¸ªå·¨å¤§çš„ç¦éŸ³ï¼Œå¤§å¤§ç®€åŒ–äº†å°†ç‰©ç†å‰¯æœ¬è½¬åŒ–ä¸ºé€»è¾‘å‰¯æœ¬çš„æ­¥éª¤ã€‚

pg_createsubscriber to create a logical replica from a physical standby server

- Speed up creation of logical subscriber
- It can be used for upgrades

å¦å¤–åŸæ–‡ä¸­æ‰€è¯´çš„æœ€åä¸€ç‚¹ï¼Œåœ¨ 17 ç‰ˆæœ¬çœ‹ä¼¼ä¹Ÿå·²è§£å†³ã€‚å…·ä½“å¯ä»¥å‚ç…§ä¸Šé¢çš„é‚®ä»¶

ä»¥åŠå¦‚ä¸‹ğŸ”—ï¼š

- [PGConf.dev 2024 - New logical replication features in PostgreSQL 17](https://www.postgresql.fastware.com/blog/new-logical-replication-features-in-postgresql-17)
- [Whatâ€™s New In PostgreSQL 17](https://www.metisdata.io/blog/whats-new-in-postgresql-17)
- https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9a17be1e244a45a77de25ed2ada246fd34e4557d
