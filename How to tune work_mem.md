# How to tune work_mem

>æˆ‘æ¯å¤©éƒ½ä¼šå‘å¸ƒä¸€ç¯‡æ–°çš„ PostgreSQL "howto" æ–‡ç« ã€‚åŠ å…¥æˆ‘çš„æ—…ç¨‹å§ â€” è®¢é˜…ã€æä¾›åé¦ˆã€åˆ†äº«ï¼

`work_mem` ç”¨äºŽæŸ¥è¯¢æ‰§è¡ŒæœŸé—´æŽ’åºå’Œå“ˆå¸Œæ“ä½œçš„å†…å­˜åˆ†é…ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå…¶å¤§å°ä¸º 4MBã€‚ ç”±äºŽå…¶æ€§è´¨ï¼Œè°ƒä¼˜ `work_mem` ç›¸å¯¹å¤æ‚ã€‚

è¿™é‡Œä»‹ç»äº†ä¸€ç§å¯èƒ½çš„è°ƒä¼˜æ–¹æ³•ã€‚

## work_mem çš„ç²—ç•¥è°ƒä¼˜å’Œå®‰å…¨å€¼

é¦–å…ˆï¼ŒæŒ‰ç…§ [Day 89: Rough configuration tuning (80/20 rule; OLTP)](https://postgres-howto.cn/#/./docs/89) ä¸­çš„æè¿°è¿›è¡Œç²—ç•¥ä¼˜åŒ–ã€‚

ä¸€ä¸ªæŸ¥è¯¢å¯èƒ½ä¼šå¤šæ¬¡"æ¶ˆè€—" `work_mem` (ç”¨äºŽå¤šä¸ªæ“ä½œ)ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯ä¸ºæ¯ä¸ªæ“ä½œéƒ½å®Œå…¨åˆ†é… â€” ä¸€äº›æ“ä½œå¯èƒ½åªéœ€è¦è¾ƒå°‘çš„å†…å­˜ã€‚

å› æ­¤ï¼Œå¾ˆéš¾å¯é åœ°é¢„æµ‹å¤„ç†å·¥ä½œè´Ÿè½½æ—¶éœ€è¦ä½¿ç”¨å¤šå°‘å†…å­˜ï¼Œè€Œä¸ç»è¿‡å¯¹å·¥ä½œè´Ÿè½½çš„å®žé™…è§‚å¯Ÿã€‚

æ­¤å¤–ï¼Œåœ¨ PostgreSQL 13 ä¸­ï¼Œæ–°å¢žäº†ä¸€ä¸ªå‚æ•° [hash_mem_multiplier](https://postgresqlco.nf/doc/en/param/hash_mem_multiplier/)ï¼Œè°ƒæ•´äº†ç›¸å…³é€»è¾‘ã€‚PG 13-16 ç‰ˆæœ¬ä¸­çš„é»˜è®¤å€¼ä¸º 2ï¼Œè¿™æ„å‘³ç€å•ä¸ªå“ˆå¸Œæ“ä½œæ‰€ç”¨çš„æœ€å¤§å†…å­˜ä¸º `2 * work_mem`ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ Linux ä¸­äº†è§£ä¼šè¯ä½¿ç”¨äº†å¤šå°‘å†…å­˜æœ¬èº«æ˜¯éžå¸¸å›°éš¾çš„ â€” å¯ä»¥å‚è€ƒAndres Freund çš„ç²¾å½©æ–‡ç« ï¼š[Analyzing the Limits of Connection Scalability in Postgres](https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/analyzing-the-limits-of-connection-scalability-in-postgres/ba-p/1757266#memory-usage) (2020 å¹´)ã€‚

ä¸€ç§å®‰å…¨çš„è°ƒä¼˜æ–¹æ³•æ˜¯ï¼š

- ä¼°ç®—å¯ç”¨å†…å­˜ â€” ä»Žä¸­å‡åŽ» `shared_buffers`ã€`maintenance_work_mem` ç­‰
- ç„¶åŽå°†ä¼°ç®—çš„å¯ç”¨å†…å­˜é™¤ä»¥ `max_connections` å’Œä¸€ä¸ªé™„åŠ å€¼ (ä¾‹å¦‚ 4-5ï¼Œæˆ–è€…æ›´å¤šï¼Œä»¥ç¡®ä¿å®‰å…¨) â€” å‡è®¾æ¯ä¸ªåŽç«¯è¿›ç¨‹æœ€å¤šä½¿ç”¨ `4 * work_mem` æˆ– `5 * work_mem`ã€‚å½“ç„¶ï¼Œè¿™ä¸ªä¹˜æ•°æœ¬èº«åªæ˜¯ä¸€ä¸ªç²—ç•¥ä¼°è®¡ â€” å®žé™…ä¸Šï¼ŒOLTP å·¥ä½œè´Ÿè½½é€šå¸¸å¯¹å†…å­˜çš„éœ€æ±‚è¿œè¿œä½ŽäºŽè¿™ä¸ªå€¼ (ä¾‹å¦‚ï¼Œè¿›è¡Œå¤§é‡ä¸»é”®æŸ¥æ‰¾æ„å‘³ç€å¹³å‡å†…å­˜æ¶ˆè€—éžå¸¸ä½Ž)ã€‚

åœ¨å®žè·µä¸­ï¼Œè°ƒæ•´ `work_mem` è‡³ä¸€ä¸ªè¾ƒé«˜å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†å‰ææ˜¯ç†è§£äº† PostgreSQL åœ¨ç‰¹å®šå·¥ä½œè´Ÿè½½ä¸‹çš„è¡Œä¸ºä¹‹åŽå†è¿›è¡Œã€‚ä»¥ä¸‹æ­¥éª¤æ˜¯è¿›ä¸€æ­¥è°ƒä¼˜çš„è¿­ä»£æ–¹æ³•çš„ä¸€éƒ¨åˆ†ã€‚

## ä¸´æ—¶æ–‡ä»¶ç›‘æŽ§

ç›‘æŽ§ä¸´æ—¶æ–‡ä»¶çš„åˆ›å»ºé¢‘çŽ‡åŠå…¶å¤§å°ã€‚ç›¸å…³ä¿¡æ¯æ¥æºï¼š

- `pg_stat_database`ï¼Œ`temp_files` å’Œ `temp_bytes` åˆ—ã€‚
- PostgreSQL æ—¥å¿— â€” è®¾ç½® `log_temp_files` ä¸ºä¸€ä¸ªè¾ƒä½Žçš„å€¼ï¼Œç”šè‡³ä¸º 0 (éœ€è¦æ³¨æ„è§‚å¯Ÿè€…æ•ˆåº”)ã€‚
- `pg_stat_statements` ä¸­çš„ `temp_blks_read` å’Œ `temp_blks_written`ã€‚

è¿›ä¸€æ­¥è°ƒä¼˜ `work_mem` çš„ç›®æ ‡æ˜¯å®Œå…¨æ¶ˆé™¤ä¸´æ—¶æ–‡ä»¶çš„åˆ›å»ºï¼Œæˆ–å°½é‡å‡å°‘å…¶åˆ›å»ºé¢‘çŽ‡å’Œå¤§å°ã€‚

## ä¼˜åŒ–æŸ¥è¯¢

å¦‚æžœå¯èƒ½ï¼Œè€ƒè™‘ä¼˜åŒ–é‚£äº›æ¶‰åŠä¸´æ—¶æ–‡ä»¶åˆ›å»ºçš„æŸ¥è¯¢ã€‚ä¸ºæ­¤æŠ•å…¥é€‚å½“çš„ç²¾åŠ› â€” å¦‚æžœæ²¡æœ‰æ˜Žæ˜¾çš„ä¼˜åŒ–ç©ºé—´ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚

## è¿›ä¸€æ­¥æå‡work_memï¼šå¤šå°‘åˆé€‚ï¼Ÿ

å¦‚æžœå·²ç»åšäº†åˆç†çš„ä¼˜åŒ–å·¥ä½œï¼ŒçŽ°åœ¨å¯ä»¥è€ƒè™‘è¿›ä¸€æ­¥æé«˜ `work_mem`ã€‚

ç„¶è€Œï¼Œæå‡å¤šå°‘åˆé€‚å‘¢ï¼Ÿç­”æ¡ˆå–å†³äºŽå•ä¸ªä¸´æ—¶æ–‡ä»¶çš„å¤§å° â€” é€šè¿‡ä¸Šé¢æè¿°çš„ç›‘æŽ§ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æœ€å¤§å’Œå¹³å‡ä¸´æ—¶æ–‡ä»¶å¤§å°ï¼Œå¹¶ä»Žä¸­ä¼°ç®—æ‰€éœ€çš„æå‡é‡ã€‚

> ðŸŽ¯ **TODO:** è¯¦ç»†æ­¥éª¤

## é’ˆå¯¹éƒ¨åˆ†å·¥ä½œè´Ÿè½½æå‡work_mem

é’ˆå¯¹å•ä¸ªæŸ¥è¯¢æé«˜ `work_mem` æ˜¯æœ‰æ„ä¹‰çš„ã€‚è€ƒè™‘ä¸¤ç§æ–¹å¼ï¼š

- åœ¨å•ä¸ªä¼šè¯æˆ–äº‹åŠ¡ä¸­è®¾ç½® `work_mem` (ä½¿ç”¨ `set local ...`)ï¼Œæˆ–è€…
- å¦‚æžœä¸ºä¸åŒçš„å·¥ä½œè´Ÿè½½éƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“ç”¨æˆ·ï¼Œè€ƒè™‘é’ˆå¯¹ç‰¹å®šç”¨æˆ·è°ƒæ•´ `work_mem` (ä¾‹å¦‚ï¼Œé’ˆå¯¹é‚£äº›æ‰§è¡Œåˆ†æžç±»æŸ¥è¯¢çš„ç”¨æˆ·)ï¼š`alter user ... set work_mem ...`ã€‚

## å…¨å±€æå‡work_mem

åªæœ‰åœ¨å‰è¿°æ­¥éª¤ä¸é€‚ç”¨æ—¶ (ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å›°éš¾ä¸”æ— æ³•é’ˆå¯¹éƒ¨åˆ†å·¥ä½œè´Ÿè½½è°ƒä¼˜ `work_mem`) æ‰è€ƒè™‘å…¨å±€æå‡ `work_mem`ï¼ŒåŒæ—¶è¯„ä¼° OOM çš„é£Žé™©ã€‚

## è¿­ä»£ä¼˜åŒ–

ä¸€æ®µæ—¶é—´åŽï¼Œå®¡æŸ¥ç›‘æŽ§æ•°æ®ï¼Œç¡®ä¿æƒ…å†µæœ‰æ‰€æ”¹å–„ï¼Œæˆ–å†³å®šè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£ã€‚

## é¢å¤–å†…å®¹ï¼špg_get_backend_memory_contexts

åœ¨ PostgreSQL 14 ä¸­ï¼Œæ–°å¢žäº†ä¸€ä¸ªå‡½æ•° `pg_get_backend_memory_contexts()` åŠå…¶å¯¹åº”çš„è§†å›¾ï¼›è¯·å‚è€ƒ[æ–‡æ¡£](https://postgresql.org/docs/current/view-pg-backend-memory-contexts.html)ã€‚è¿™å¯¹äºŽè¯¦ç»†åˆ†æžå½“å‰ä¼šè¯å¦‚ä½•ä½¿ç”¨å†…å­˜éžå¸¸æœ‰å¸®åŠ©ï¼Œä½†è¯¥åŠŸèƒ½çš„ä¸»è¦é™åˆ¶æ˜¯å®ƒåªèƒ½ä¸Žå½“å‰ä¼šè¯ä¸€èµ·ä½¿ç”¨ã€‚

> ðŸŽ¯ **TODO:** å¦‚ä½•ä½¿ç”¨å®ƒã€‚

